<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance - MSEDCL Worker Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='worker_attendance.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
     
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('worker_dashboard') }}">
                <i class="fas fa-bolt me-2"></i>
                MSEDCL Worker Portal
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i> {{ user_name }}
                </span>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="d-flex flex-column p-3">
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('worker_dashboard') }}">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{{ url_for('worker_attendance') }}">
                                <i class="fas fa-calendar-check"></i> Attendance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('worker_tasks') }}">
                                <i class="fas fa-tasks"></i> My Tasks
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('worker_equipment') }}">
                                <i class="fas fa-tools"></i> Equipment
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('worker_leave') }}">
                                <i class="fas fa-umbrella-beach"></i> Leave
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('worker_profile') }}">
                                <i class="fas fa-user"></i> Profile
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">
                        <i class="fas fa-calendar-check me-2 text-danger"></i>Attendance Management
                    </h2>
                </div>

                <div class="row">
                    <!-- Left Column - Mark Attendance -->
                    <div class="col-lg-6">
                        <div class="attendance-form">
                            <h4 class="mb-4"><i class="fas fa-edit me-2 text-danger"></i>Mark Today's Attendance</h4>
                            
                            <form id="attendanceForm">
                                <div class="mb-3">
                                    <label for="date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="date" name="date" 
                                           value="{{ today }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" name="status" required>
                                        <option value="Present">Present</option>
                                        <option value="Absent">Absent</option>
                                        <option value="Leave">Leave</option>
                                    </select>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="in_time" class="form-label">In Time</label>
                                        <input type="time" class="form-control" id="in_time" name="in_time">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="out_time" class="form-label">Out Time</label>
                                        <input type="time" class="form-control" id="out_time" name="out_time">
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <small>
                                        <i class="fas fa-info-circle me-1"></i>
                                        Note: In Time and Out Time are optional for Absent/Leave status.
                                    </small>
                                </div>
                                
                                <button type="submit" class="btn btn-msedcl w-100">
                                    <i class="fas fa-save me-2"></i>Mark Attendance
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Right Column - Monthly Stats -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-2"></i>This Month's Summary
                            </div>
                            <div class="card-body">
                                {% if monthly_stats and monthly_stats[0] %}
                                {% set current_month = monthly_stats[0] %}
                                {% set attendance_rate = (current_month.present_days / current_month.total_days * 100) if current_month.total_days > 0 else 0 %}
                                
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <span class="stat-number">{{ current_month.present_days }}</span>
                                        <span class="stat-label">Present</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-number">{{ current_month.absent_days }}</span>
                                        <span class="stat-label">Absent</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-number">{{ current_month.leave_days }}</span>
                                        <span class="stat-label">Leave</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-number">{{ current_month.total_days }}</span>
                                        <span class="stat-label">Total</span>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h6>Attendance Rate</h6>
                                    <div class="progress attendance-progress">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             data-width="{{ attendance_rate }}"
                                             aria-valuenow="{{ attendance_rate }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ "%.1f"|format(attendance_rate) }}%
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                    <p>No attendance data available for this month</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Recent Months -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <i class="fas fa-history me-2"></i>Recent Months
                            </div>
                            <div class="card-body">
                                {% if monthly_stats %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Month</th>
                                                <th>Present</th>
                                                <th>Absent</th>
                                                <th>Leave</th>
                                                <th>Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for month in monthly_stats %}
                                            <tr>
                                                <td>{{ month.month }}/{{ month.year }}</td>
                                                <td>{{ month.present_days }}</td>
                                                <td>{{ month.absent_days }}</td>
                                                <td>{{ month.leave_days }}</td>
                                                <td>
                                                    {% set rate = (month.present_days / month.total_days * 100) if month.total_days > 0 else 0 %}
                                                    <span class="badge {% if rate >= 90 %}bg-success{% elif rate >= 75 %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ "%.0f"|format(rate) }}%
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="text-muted text-center">No historical data available</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance History -->
                <div class="card mt-4">
                    <div class="card-header">
                        <i class="fas fa-list me-2"></i>Attendance History (Current Month)
                    </div>
                    <div class="card-body">
                        {% if attendance_records %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Day</th>
                                        <th>Status</th>
                                        <th>In Time</th>
                                        <th>Out Time</th>
                                        <th>Working Hours</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in attendance_records %}
                                    <tr class="attendance-status-{{ record.status|lower }}">
                                        <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ record.date.strftime('%A') }}</td>
                                        <td>
                                            <span class="badge {% if record.status == 'Present' %}bg-success{% elif record.status == 'Absent' %}bg-danger{% else %}bg-warning{% endif %}">
                                                {{ record.status }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if record.in_time %}
                                                {{ record.in_time }}
                                            {% else %}
                                                --
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if record.out_time %}
                                                {{ record.out_time }}
                                            {% else %}
                                                --
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if record.working_hours is not none %}
                                                {{ record.working_hours }} hrs
                                            {% else %}
                                                --
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-calendar-times fa-3x mb-3"></i>
                            <p>No attendance records found for this month</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // Set progress bar width from data attribute
            const progressBars = document.querySelectorAll('.progress-bar[data-width]');
            progressBars.forEach(bar => {
                const width = bar.getAttribute('data-width');
                bar.style.width = width + '%';
            });
            
            // Handle form submission
            document.getElementById('attendanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                fetch('/api/mark-attendance', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Attendance marked successfully!');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error marking attendance');
                });
            });
            
            // Show/hide time fields based on status
            const statusSelect = document.getElementById('status');
            const timeFields = document.getElementById('in_time').closest('.row');
            
            function toggleTimeFields() {
                if (statusSelect.value === 'Present') {
                    timeFields.style.display = 'flex';
                } else {
                    timeFields.style.display = 'none';
                }
            }
            
            statusSelect.addEventListener('change', toggleTimeFields);
            toggleTimeFields(); // Initial call
        });
    </script>
</body>
</html>